<!DOCTYPE html>
<html lang="en">

<head>
  <title>iFLUX Rule Editor</title>
  <link rel="stylesheet" href="stylesheets/styles.css">
  <link rel="stylesheet" href="stylesheets/style.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
  <style type="text/css" media="screen">
    body {
      margin-bottom: 30px;
    }
    .editor {
      width: 100%;
      height: 200px;
    }
  </style>
</head>

<body>
  <header id="header">
    <h1><a href="http://www.iflux.io">iFlux.io</a></h1>
    <nav id="nav">
      <ul>
        <li style="white-space: nowrap;"><a href="http://www.iflux.io/blog.html">Blog</a>
        </li>
        <li style="white-space: nowrap;"><a href="http://www.iflux.io/api/">API</a>
        </li>
      </ul>
    </nav>
  </header>

  <div class="container">
    <div class="page-header">
      <h1>iFLUX Rule Editor</h1>
    </div>
    <div class="container">
      <div class="row">
        <div class="panel panel-info">
          <div class="panel-heading">
            <h3 class="panel-title">How to use the editor</h3>
          </div>
          <div class="panel-body">
            The iFLUX programming model is based on <b>Event-Condition-Action</b> rules:
            <p></p>
            <ol>
              <li><b>Event sources</b> push <b>events</b> to the <code>/events</code> API endpoint (exposed by the iFLUX middleware).</li>
              <p></p>
              <li>The <b>rules</b> which have been configured on the middleware are evaluated. Every rule specify certain <b>conditions</b> (on the source, the event type, the event properties). Every rule also specify an <b>action</b>, which should be triggered if all conditions are met when an event is received. Every rule also specifies how the action properties should be computed (based on the triggering event properties).</li>
              <p></p>
              <li>When an <b>action</b> is triggered, the iFLUX middleware issues an HTTP request to the <code>/actions</code> API endpoint (exposed by an iFLUX-compatible actuator or gateway.</li>
            </ol>
            <p></p>
            <br>
            The iFLUX middleware exposes the <code>/rules</code> API endpoint, so that users can <b>create new rules</b>. The payload accepted by the endpoint can be a bit tricky to write. The objective of this editor is to address this issue and to make the process easier. Using the editor involves three steps:
            <p></p>
            <ol>
              <li>Specify the <b>IF</b> clause of the rule, by defining conditions on the event source and the event type (conditions on event properties are not supported yet). In this step, also provide an example of event that would trigger the rule (this will make the next step easier).</li>
              <p></p>
              <li>Specify the <b>THEN</b> clause of the rule. To do that, you will first specify an action target endpoint (this URL points to an action target component, such as an actuator or a gateway). You will also provide a schema that specifies how to generate the action payload (both the action type and the action properties).</li>
              <p></p>
              <li>Finally, the editor will <b>generate a rule payload</b>. You can then grab this JSON data and POST it to the <code>/rules</code> API endpoint to add the rule to your iFLUX setup.</li>
              <p></p>
            </ol>
          </div>
        </div>
      </div>
      <br>
      <div class="row">
        <div class="alert alert-info" role="alert">
          <b>Preamble</b>: Describe what the rule is supposed to do.
        </div>
      </div>
      <br>
      <div class="row">
        <div class="col-md-9">
          <label for="tfRuleDescription">Describe what the rule should do.</label>
          <input type="text" class="form-control" id="tfRuleDescription" placeholder="If something happens, then do something">
        </div>
      </div>
      <br>
      <br>
      <br>
      <div class="row">
        <div class="alert alert-info" role="alert">
          <b>Step 1</b>: <b>IF</b> this event happens...
        </div>
      </div>
      <br>
      <div class="row">
        <div class="col-md-9">
          <label for="tfEventSource">Do you want to trigger the rule only if the event is notified by a specific source? If not, you can indicate *</label>
          <input type="text" class="form-control" id="tfEventSource" placeholder="*, http://api.flux.io/eventSources/82983">
        </div>
        <div class="col-md-3">
          <div class="panel panel-info">
            <div class="panel-heading">
              <h5 class="panel-title">Event source</h5>
            </div>
            <div class="panel-body">
              <p>An event source is a particular sensor (hardware or software), which is registered on the iFLUX platform and which issues event notifications.</p>
              <p><b>Example:</b> a thermometer</p>
              <p>
                <input id="bSampleEventSourceAny" class="btn btn-primary btn-xs" type="button" value="any (*)">
                <input id="bSampleEventSourceThermometer" class="btn btn-primary btn-xs" type="button" value="thermometer">
              </p>
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="row">
        <div class="col-md-9">
          <label for="tfEventSource">Do you want to trigger the rule only for a specific type of event? You can also enter *</label>
          <input type="text" class="form-control" id="tfEventType" placeholder="*, http://api.flux.io/schemas/userActionEvent">
        </div>
        <div class="col-md-3">
          <div class="panel panel-info">
            <div class="panel-heading">
              <h3 class="panel-title">Event type</h3>
            </div>
            <div class="panel-body">
              <p>Event sources emit events of different types. A type is associated with a list of properties.</p>
              <p><b>Example:</b> a temperature event</p>
              <p>
                <input id="bSampleEventTypeAny" class="btn btn-primary btn-xs" type="button" value="any (*)">
                <input id="bSampleEventTypeTemperature" class="btn btn-primary btn-xs" type="button" value="temperature">
              </p>
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="row">
        <div class="col-md-9">
          <label for="tfEventSource">Enter an example of event, so that you can test the rule.</label>
          <div id="eventEditor" class="editor">
            { "timestamp" : "2015-01-12T05:21:07Z", "source" : "/event-sources/JI8928JFK", "type" : "/eventTypes/temperatureEventSchema", "properties" : { "temperature" : 22.5, "location" : "room 1" } }
          </div>
        </div>
        <div class="col-md-3">
          <div class="panel panel-info">
            <div class="panel-heading">
              <h3 class="panel-title">Event</h3>
            </div>
            <div class="panel-body">
              <p>An iFLUX event is defined by a source, a type, a timestamp and a list of custom properties.</p>
              <p><b>Example:</b> a temperature event may have 2 custom properties: location and temperature</p>
              <p>
                <input id="bSampleEventTemperature" class="btn btn-primary btn-xs" type="button" value="temperature event">
              </p>
            </div>
          </div>
        </div>
      </div>
      <br>
      <br>
      <br>
      <div class="row">
        <div class="alert alert-info" role="alert">
          <b>Step 2</b>: ...<b>THEN</b> trigger this action!
        </div>
      </div>
      <!--
      <br>
      <div class="row">
        <div class="col-md-9">
          <label for="tfEventSource">Select the type of action that you want to trigger.</label>
          <input type="text" class="form-control" id="tfEventSource" placeholder="*, http://api.flux.io/eventSources/82983">
        </div>
        <div class="col-md-3">
          <div class="panel panel-info">
            <div class="panel-heading">
              <h5 class="panel-title">Action type</h5>
            </div>
            <div class="panel-body">
              <p>Action targets can react to various types of actions. An action type defines a list of custom properties.</p>
              <p><b>Example:</b> a street light controller might react to turn-on and turn-off actions. The turn-off action type might define a time property, making it possible to specify when the light should be switched off.</p>
            </div>
          </div>
        </div>
      </div>
-->
      <br>
      <div class="row">
        <div class="col-md-9">
          <label for="tfEventSource">Select API endpoint provided by your action target.</label>
          <input type="text" class="form-control" id="tfActionTarget" placeholder="https://actuator-gateway.iflux.io/api">
        </div>
        <div class="col-md-3">
          <div class="panel panel-info">
            <div class="panel-heading">
              <h5 class="panel-title">Action target</h5>
            </div>
            <div class="panel-body">
              <p>An iFLUX action target implements the /actions/ endpoint defined in the iFLUX API. It accepts action payloads and executes them.</p>
              <p><b>Example:</b> a street light controller might accept actions to turn lights on and off.</p>
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="row">
        <div class="col-md-9">
          <div id="schemaEditor" class="editor">{"type" : "sendEmail", "properties" : {"email" : "aware", "subject" : "New temperature", "body" : "The temperature in {{ properties.location }} is now: {{ properties.temperature }}." }}</div>
        </div>
        <div class="col-md-3">
          <div class="panel panel-info">
            <div class="panel-heading">
              <h3 class="panel-title">Define a transformation schema (Handlebars)</h3>
            </div>
            <div class="panel-body">
              The schema specifies how to generate an action, based on the incoming event properties.
            </div>
          </div>
        </div>
      </div>
      <br>
      <br>
      <br>
      <div class="row">
        <div class="alert alert-success" role="alert">
          <b>Step 3</b>: Generate and grab an <b>API request</b> to create the rule.</h2>
        </div>
      </div>
      <br>
      <div class="row">
        <div class="col-md-9">
          <div id="actionEditor" class="editor">{"timestamp": "now","type": "hello"}</div>
        </div>
        <div class="col-md-3">
          <div class="panel panel-success">
            <div class="panel-heading">
              <h3 class="panel-title">Check the result action payload.</h3>
            </div>
            <div class="panel-body">
              An iFLUX action is defined by a type and a list of properties.
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="row">
        <div class="col-md-9">
          <div id="apiRequestEditor" class="editor"></div>
        </div>
        <div class="col-md-3">
          <div class="panel panel-success">
            <div class="panel-heading">
              <h5 class="panel-title">API request</h5>
            </div>
            <div class="panel-body">
              <input id="bRecompute" class="btn btn-success" type="button" value="Generate">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.min.js"></script>
  <script>
    $(function () {
      var eventEditor = ace.edit("eventEditor");
      eventEditor.setTheme("ace/theme/idle_fingers");
      eventEditor.getSession().setMode("ace/mode/json");
      eventEditor.setShowPrintMargin(false);
      eventEditor.setValue(JSON.stringify(JSON.parse(eventEditor.getValue()), null, '\t'));
      eventEditor.clearSelection();

      var schemaEditor = ace.edit("schemaEditor");
      schemaEditor.setTheme("ace/theme/idle_fingers");
      schemaEditor.getSession().setMode("ace/mode/json");
      schemaEditor.setShowPrintMargin(false);
      schemaEditor.getSession().setUseWrapMode(true);
      schemaEditor.setValue(JSON.stringify(JSON.parse(schemaEditor.getValue()), null, '\t'));
      schemaEditor.clearSelection();
      //schemaEditor.on("change", compute );

      var actionEditor = ace.edit("actionEditor");
      actionEditor.setTheme("ace/theme/kuroir");
      actionEditor.getSession().setMode("ace/mode/json");
      actionEditor.setShowPrintMargin(false);
      actionEditor.getSession().setUseWrapMode(true);
      var template = Handlebars.compile(schemaEditor.getValue());
      var action = JSON.parse(template(JSON.parse(eventEditor.getValue())));
      actionEditor.setValue(JSON.stringify(action, null, '\t'));
      actionEditor.clearSelection();
      actionEditor.setReadOnly(true);
      //actionEditor.renderer.setShowGutter(false);

      var apiRequestEditor = ace.edit("apiRequestEditor");
      apiRequestEditor.setTheme("ace/theme/kuroir");
      apiRequestEditor.getSession().setMode("ace/mode/json");
      apiRequestEditor.setShowPrintMargin(false);
      apiRequestEditor.getSession().setUseWrapMode(true);
      apiRequestEditor.setReadOnly(false);


      function compute() {
        var template = Handlebars.compile(schemaEditor.getValue());
        var action = JSON.parse(template(JSON.parse(eventEditor.getValue())));
        actionEditor.setValue(JSON.stringify(action, null, '\t'));
        actionEditor.clearSelection();
      };

      function generatePostRuleRequest() {
        var payload = {};
        payload.description = $("#tfRuleDescription").val();
        payload.if = {};
        payload.if.eventSource = $("#tfEventSource").val();
        payload.if.eventType = $("#tfEventType").val();
        payload.if.eventProperties = {};
        payload.then = {};
        payload.then.actionTarget = $("#tfActionTarget").val();
        payload.then.actionSchema = JSON.stringify(JSON.parse(schemaEditor.getValue()));
        return payload;
      }

      function generatePostActionRequest() {}

      $("#bRecompute").click(function () {
        compute();
        apiRequestEditor.setValue(JSON.stringify(generatePostRuleRequest(), null, "\t"));
        apiRequestEditor.clearSelection();
      });

      $("#bSampleEventSourceThermometer").click(function () {
        $("#tfEventSource").val("https://api.iflux.com/eventSources/JKEJ8282");
      });
      $("#bSampleEventSourceAny").click(function () {
        $("#tfEventSource").val("*");
      });


    });
  </script>

</body>

</html>